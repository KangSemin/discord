<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="icon" href="icons8.ico">
    <title>#세미니 방명록</title>
    

    
    <script type="module" src="firebase.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBaXJwGWaOWgnmF3WJh1VP1r1wlzbwlyc8",
            authDomain: "semin-1b8f3.firebaseapp.com",
            projectId: "semin-1b8f3",
            storageBucket: "semin-1b8f3.firebasestorage.app",
            messagingSenderId: "242097872958",
            appId: "1:242097872958:web:1c6b4d38dbf4b841f5f16f",
            measurementId: "G-J52LLZ9MGZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const form = document.getElementById('guestbook-form');
        const entriesContainer = document.getElementById('guestbook-entries');
        const activeUsersCollection = collection(db, "activeUsers");

        const guestbookCollection = query(collection(db, "guestBook"), orderBy("timestamp"));

        onSnapshot(guestbookCollection, (snapshot) => {
            entriesContainer.innerHTML = ''; // 기존 메시지 비우기
            snapshot.forEach(doc => {
                const entry = doc.data();
                const entryDiv = document.createElement('div');
                entryDiv.className = 'entry';
                entryDiv.innerHTML = `
                    <img src="${entry.profileImage}" alt="Profile Image" class="profile-image">
                    <div class="entry-content">
                        <div class="entry-header">
                            <strong>${entry.name}</strong>
                            <span class="timestamp">${entry.timestamp}</span>
                        </div>
                        <p>${entry.message}</p>
                    </div>`;
                entriesContainer.appendChild(entryDiv);
            });

            entriesContainer.scrollTop = entriesContainer.scrollHeight; // 최신 메시지가 보이도록 스크롤 이동
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const message = document.getElementById('message').value;
            const timestamp = new Date().toLocaleString();

            if (!username) {
                alert("Please enter your name to proceed.");
                return;
            }

            try {
                // 방명록에 메시지를 추가
                await addDoc(collection(db, "guestBook"), {
                    name: username,
                    profileImage: profileImage,
                    message: message,
                    timestamp: timestamp
                });

                form.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        let username = '';
        let profileImage = 'https://i.ibb.co/TMYyS1k/01.png';
        let userDocRef;

        document.getElementById('profile-image-selection').addEventListener('click', (event) => {
            if (event.target.classList.contains('profile-image-option')) {
                document.querySelectorAll('.profile-image-option').forEach(img => {
                    img.classList.remove('selected');
                });
                event.target.classList.add('selected');
                profileImage = event.target.getAttribute('data-image');
            }
        });

        document.getElementById('name-confirm').addEventListener('click', async () => {
            username = document.getElementById('username-input').value;
            if (username) {
                document.getElementById('name-modal').style.display = 'none';
                document.querySelector('.container').classList.remove('blurred');

                try {
                    userDocRef = doc(db, "activeUsers", username);
                    await setDoc(userDocRef, { name: username, profileImage: profileImage });
                } catch (error) {
                    console.error("Error setting active user: ", error);
                }
            } else {
                alert("오잉?");
            }
        });

        function updateUserList(snapshot) {
            const userListElement = document.getElementById('userList');
            userListElement.innerHTML = ''; // 기존 사용자 목록 비우기

            // 사용자 수 계산
            let userCount = snapshot.size;

            snapshot.forEach((doc) => {
                const user = doc.data();
                const li = document.createElement('li');
                li.classList.add('user-item');
                li.innerHTML = `
                    <img src="${user.profileImage}" class="profile-image">
                    <span class="username">${user.name}</span>
                `;
                userListElement.appendChild(li);
            });

            // 사용자 수 업데이트
            document.getElementById('user-count').innerText = `${userCount}`;
        }

        window.addEventListener('beforeunload', async () => {
            if (userDocRef) {
                await deleteDoc(userDocRef);
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            // 사용자 목록 실시간 갱신
            onSnapshot(activeUsersCollection, (snapshot) => {
                updateUserList(snapshot);
            });
        });
    </script>
</head>

<body>
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <h2>이름을 입력해주세요</h2>
            <input type="text" id="username-input" placeholder="이름을 입력해주세요" required>
            <label for="profile-image-input">프로필을 골라주세요</label>
            <div id="profile-image-selection">
                <img src="https://i.ibb.co/TMYyS1k/01.png" alt="Profile 1" class="profile-image-option"
                    data-image="https://i.ibb.co/TMYyS1k/01.png">
                <img src="https://i.ibb.co/B4WFsh5/02.png" alt="Profile 2" class="profile-image-option"
                    data-image="https://i.ibb.co/B4WFsh5/02.png">
                <img src="https://i.ibb.co/r0hKkDy/03.png" alt="Profile 3" class="profile-image-option"
                    data-image="https://i.ibb.co/r0hKkDy/03.png">
                <img src="https://i.ibb.co/ZVwYFSH/04.png" alt="Profile 4" class="profile-image-option"
                    data-image="https://i.ibb.co/ZVwYFSH/04.png">
                <img src="https://i.ibb.co/NjyNXpp/05.png" alt="Profile 5" class="profile-image-option"
                    data-image="https://i.ibb.co/NjyNXpp/05.png">
                <img src="https://i.ibb.co/ypbwq1V/06.png" alt="Profile 6" class="profile-image-option"
                    data-image="https://i.ibb.co/ypbwq1V/06.png">
                <img src="https://i.ibb.co/jHbVK9r/07.png" alt="Profile 7" class="profile-image-option"
                    data-image="https://i.ibb.co/jHbVK9r/07.png">
                <img src="https://i.ibb.co/ZLbXCbH/08.png" alt="Profile 8" class="profile-image-option"
                    data-image="https://i.ibb.co/ZLbXCbH/08.png">
                <img src="https://i.ibb.co/rM38Qjx/09.png" alt="Profile 9" class="profile-image-option"
                    data-image="https://i.ibb.co/rM38Qjx/09.png">
            </div>
            <button id="name-confirm">확인</button>
        </div>
    </div>

    <div class="container">
        <h1>#세미니 방명록⭐</h1>
        <div class="guestbook-layout">
            <div id="guestbook-entries"></div>
            <div id="user-list">
                <h2>현재 사용자 -<span id="user-count">0</span></h2>
                <ul id="userList"></ul>
            </div>
        </div>
        <form id="guestbook-form">
            <textarea id="message" placeholder="#세미니 방명록⭐에 메세지 보내기" required></textarea>
            <button type="submit">보내기</button>
        </form>
    </div>
</body>

</html>